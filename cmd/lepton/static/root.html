<html>
<head>
  <title>go-lepton</title>
  <style>
    .errorMsg {
      color: red;
    }
    .info {
      white-space: pre-wrap;
    }
    .mainImg {
      border: 1px solid #000000;
    }
  </style>
  <script>
    function onload() {
      var can = document.getElementById("canvas1");
      var context = can.getContext("2d");
      var image = document.createElement("img");
      var errorMsg = document.getElementById("errorMsg");
      var info = document.getElementById("info");

      var socket = new WebSocket(websocketURL("/stream"));
      socket.addEventListener("message", function(event) {
        // metadata is json encoded structure.
        var rawMetadata = event.data.split('\n', 1)[0];
        // img is base64 encoded PNG.
        var img = event.data.slice(rawMetadata.length);
        image.src = 'data:image/png;base64,' + img;
        context.drawImage(image, 0, 0, 800, 600);
        var metadata = JSON.parse(rawMetadata);
        info.innerText = JSON.stringify(metadata, null, 2);
      });
      socket.addEventListener("error", function(event) {
        errorMsg.innerText = "Websocket error" + event;
      });
      socket.addEventListener("close", function(event) {
        errorMsg.innerText = "Websocket closed";
      });
    }

    function websocketURL(s) {
      var l = window.location;
      return ((l.protocol === "https:") ? "wss://" : "ws://") + l.hostname + ":" + l.port + s;
    }
  </script>
</head>
<body onload="onload()">
  <div id="errorMsg" class="errorMsg"></div><br>
  <canvas id="canvas1" class="mainImg" width="800" height="600"></canvas>
  <br>
  Raw data:<br>
  <div id="info" class="info">Infos</div>
</body>
</html>
