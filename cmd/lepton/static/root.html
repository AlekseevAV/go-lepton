<html>
<head>
  <title>go-lepton</title>
  <style>
    .errorMsg {
      color: red;
    }
    .info {
      white-space: pre-wrap;
    }
    .mainImg {
      border: 1px solid #000000;
    }
  </style>
  <script>
    function onload() {
      var canvas = document.getElementById("canvas1");
      var context = canvas.getContext("2d");

      var canvasSmall = document.createElement('canvas');
      canvasSmall.width = 80;
      canvasSmall.height = 60;
      var contextSmall = canvasSmall.getContext("2d");
      var imgDataSmall = contextSmall.createImageData(80, 60);

      //var image = document.createElement("img");
      var errorMsg = document.getElementById("errorMsg");
      var info = document.getElementById("info");
      var Avg = document.getElementById("avg");
      var Max = document.getElementById("max");
      var Min = document.getElementById("min");

      var socket = new WebSocket(websocketURL("/stream"));
      socket.addEventListener("message", function(event) {
        // metadata is json encoded structure.
        var encodedMetadata = event.data.split('\n', 1)[0];
        var encodedImg = event.data.slice(encodedMetadata.length);

        // img is base64 encoded PNG.
        //image.src = 'data:image/png;base64,' + encodedImg;
        //context.drawImage(image, 0, 0, 800, 600);

        // img is base64 encoded uint16.
        // Convert from base64 to raw data.
        var rawImg = window.atob(encodedImg);
        // Convert from raw data to uint16 manually. In theory we should use the
        // embedded javascript thing-y but the documentation is so bad I never
        // figured out how.
        var uint16 = new Uint16Array(rawImg.length/2);
        var max = -1;
        var min = 65536;
        var avg = 0;
        for (i = 0; i < rawImg.length; i+=2) {
          // little endian.
          var l = rawImg.charCodeAt(i);
          var h = rawImg.charCodeAt(i+1);
          var v = h*256+l;
          uint16[i/2] = v;
          if (v < min) {
            min = v;
          }
          if (v > max) {
            max = v;
          }
          avg += v;
        }
        avg = avg / uint16.length;
        var delta = max-min;

        // Rasterize AGC from 14bits Gray to 8bits RGBA.
        for (var i = 0; i < uint16.length; i++) {
          var o = 4*i;
          imgDataSmall.data[o] = (uint16[i]-min) * 255/delta;
          imgDataSmall.data[o+1] = (uint16[i]-min) * 255/delta;
          imgDataSmall.data[o+2] = (uint16[i]-min) * 255/delta;
          imgDataSmall.data[o+3] = 255;
        }
        contextSmall.putImageData(imgDataSmall, 0, 0);

        // Render and stretch.
        context.save();
        context.scale(canvas.height/canvasSmall.height, canvas.width/canvasSmall.width);
        context.drawImage(canvasSmall, 0, 0);
        context.restore();

        var metadata = JSON.parse(encodedMetadata);
        info.innerText = JSON.stringify(metadata, null, 2);
        Avg.innerText = avg.toString();
        Max.innerText = max.toString();
        Min.innerText = min.toString();
      });
      socket.addEventListener("error", function(event) {
        errorMsg.innerText = "Websocket error" + event;
      });
      socket.addEventListener("close", function(event) {
        errorMsg.innerText = "Websocket closed";
      });
    }

    function websocketURL(s) {
      var l = window.location;
      return ((l.protocol === "https:") ? "wss://" : "ws://") + l.hostname + ":" + l.port + s;
    }
  </script>
</head>
<body onload="onload()">
  <div id="errorMsg" class="errorMsg"></div><br>
  <canvas id="canvas1" class="mainImg" width="800" height="600"></canvas>
  <br>
  Max: <div id="max"></div><br>
  Min: <div id="min"></div><br>
  Avg: <div id="avg"></div><br>

  Raw data:<br>
  <div id="info" class="info">Infos</div>
</body>
</html>
